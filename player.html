<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PokéPlayer - Watch Episode</title>
  <style>
    :root { --bg:#111; --card:#1c1c1c; --ink:#fff; --brand:#fdd835; }
    body { margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); }
    header { display:flex; justify-content:space-between; align-items:center; background:#222; padding:12px 20px; position:sticky; top:0; z-index:1000; }
    .logo { font-size:22px; font-weight:700; color:var(--brand); }
    nav a { color:#fff; text-decoration:none; margin:0 10px; font-size:15px; }
    nav a:hover { color:var(--brand); }

    .wrap { max-width:980px; margin:22px auto; padding:0 16px; }
    .player { background:var(--card); border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,.45); padding:16px; }
    video { width:100%; border-radius:10px; background:#000; }
    .meta { text-align:center; margin:12px 0 0; }
    .meta h2 { margin:0; color:var(--brand); font-size:20px; }
    .qualities { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:12px 0; }
    .btn { padding:8px 12px; border:0; border-radius:8px; cursor:pointer; font-weight:700; background:#2a2a2a; color:#fff; }
    .btn.active, .btn:hover { background:var(--brand); color:#111; }
    .navrow { display:flex; justify-content:space-between; margin-top:10px; gap:10px; flex-wrap:wrap; }
    .navrow a { text-decoration:none; }
    .ghost { opacity:.5; pointer-events:none; }
    .error { text-align:center; color:#ff6b6b; margin-top:10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

  <header>
    <div class="logo">PokéPlayer</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="episodes.html">Episodes</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="login.html">Login</a>
      <a href="register.html">Register</a>
    </nav>
  </header>

  <div class="wrap">
    <div class="player">
      <video id="video" controls playsinline>
        <source id="mp4src" src="" type="video/mp4">
        Your browser does not support HTML5 video.
      </video>
      <div class="meta">
        <h2 id="title">Loading…</h2>
        <div class="qualities" id="qualities"></div>
        <div class="error" id="error" style="display:none;"></div>
      </div>
      <div class="navrow">
        <a id="prev" class="btn ghost" href="#">⬅ Previous</a>
        <a id="next" class="btn ghost" href="#">Next ➡</a>
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    let epId = parseInt(qs.get("episode")) || 1;

    const $video = document.getElementById("video");
    const $mp4src = document.getElementById("mp4src");
    const $title = document.getElementById("title");
    const $qualities = document.getElementById("qualities");
    const $err = document.getElementById("error");
    const $prev = document.getElementById("prev");
    const $next = document.getElementById("next");

    let episodes = [];
    let hls;

    function setError(msg){
      $err.textContent = msg;
      $err.style.display = "block";
    }

    function clearError(){
      $err.style.display = "none";
      $err.textContent = "";
    }

    function attachSource(src){
      clearError();
      const isHls = /\.m3u8($|\?)/i.test(src);
      if (isHls && window.Hls && Hls.isSupported()) {
        if (hls) { hls.destroy(); hls = null; }
        hls = new Hls();
        hls.loadSource(src);
        hls.attachMedia($video);
      } else {
        $mp4src.src = src;
        $video.load();
      }
    }

    function renderQualities(sources){
      $qualities.innerHTML = "";
      sources.forEach((s, idx) => {
        const b = document.createElement("button");
        b.className = "btn" + (idx === 0 ? " active" : "");
        b.textContent = s.quality || (s.isHls ? "HLS" : "Source");
        b.addEventListener("click", () => {
          [...$qualities.querySelectorAll(".btn")].forEach(el=>el.classList.remove("active"));
          b.classList.add("active");
          attachSource(s.url);
        });
        $qualities.appendChild(b);
      });
    }

    function setPrevNext(total){
      $prev.href = epId > 1 ? `player.html?episode=${epId-1}` : "#";
      $next.href = epId < total ? `player.html?episode=${epId+1}` : "#";
      $prev.classList.toggle("ghost", epId <= 1);
      $next.classList.toggle("ghost", epId >= total);
    }

    async function loadEpisode(id){
      try {
        const res = await fetch("episodes.json");
        episodes = await res.json();
        const ep = episodes.find(e => e.id === id);

        if (!ep) throw new Error("Episode not found");

        $title.textContent = `Episode ${ep.id}: ${ep.title}`;
        const sources = ep.sources || [{ url: ep.url, quality: "Default" }];
        renderQualities(sources);
        attachSource(sources[0].url);
        setPrevNext(episodes.length);

      } catch (e) {
        console.error(e);
        setError("Failed to load episode!");
        $title.textContent = "Error loading episode";
      }
    }

    loadEpisode(epId);
  </script>
</body>
</html>
